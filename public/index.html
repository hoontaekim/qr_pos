<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ì¶•ì œ ì£¼ì  QR ì£¼ë¬¸</title>
<style>
body{font-family:sans-serif;margin:40px auto;max-width:360px}
button{margin:4px;padding:4px 8px}
#total{font-weight:bold;font-size:1.2em}
</style>
</head>
<body>
<h2>ğŸ» ë©”ë‰´</h2>
<div id="menu"></div>
<hr>
<label>ì…ê¸ˆìëª… <input id="name" /></label><br><br>
<div>ì´ê³„: <span id="total">0</span>ì›</div>
<button id="orderBtn">ì£¼ë¬¸í•˜ê¸°</button>

<div id="result"></div>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì „ì—­ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const cart = {};                      // {id:qty}
let locked = false;

let menu = [];                        // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ [{id,name,price,stock}]
let stockMap = {};                    // {id:ì¬ê³ }

const menuDiv   = document.getElementById('menu');
const totalSpan = document.getElementById('total');
const resultDiv = document.getElementById('result');

const urlParams = new URLSearchParams(window.location.search);
const table = parseInt(urlParams.get('table') || '0', 10);
if (!table || table < 1 || table > 20) {
  alert('QRì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. ì§ì›ì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë©”ë‰´ ë¡œë“œ & ë Œë” â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadMenu(){
  menu = await fetch('/api/menu').then(r=>r.json());
  stockMap = Object.fromEntries(menu.map(m=>[m.id, m.stock]));
  const ok = syncCartWithStock();          // ì¬ê³ ì™€ ì¹´íŠ¸ ì •í•©ì„± ì²´í¬
  renderMenu();
  return ok;
}

function renderMenu(){
  const catOrder = ['MAIN MENU','SIDE MENU','BEVERAGE','SET MENU'];
  const grouped = {};
  for (const m of menu){
    (grouped[m.category] ||= []).push(m);
  }

  menuDiv.innerHTML = '';
  catOrder.forEach(cat=>{
    if (!grouped[cat]) return;               // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ì—†ìŒ
    menuDiv.insertAdjacentHTML('beforeend', `<h3>â€¢ ${cat}</h3>`);

    grouped[cat].forEach(m=>{
      const soldout = stockMap[m.id]===0;
      menuDiv.insertAdjacentHTML('beforeend', `
        <div style="margin-left:8px">
          ${m.name} (${m.price.toLocaleString()}ì›)
          ${soldout
            ? '<span style="color:red">[í’ˆì ˆ]</span>'
            : `<button onclick="add(${m.id})">+</button>
               <span id="qty${m.id}">0</span>
               <button onclick="sub(${m.id})">-</button>`}
          <span style="font-size:.8em"> ë‚¨ì€ìˆ˜:${stockMap[m.id]}</span>
        </div>
      `);
    });
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì¹´íŠ¸ & ì´ì•¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function getItem(id){ return menu.find(x=>x.id===+id); }

function calcTotal(){
  let sum = 0;
  for (const id in cart){
    const item = getItem(id);
    if (item) sum += item.price * cart[id];
  }
  totalSpan.textContent = sum.toLocaleString();
}

/* ì¬ê³  ë³€ê²½ â†’ ì¹´íŠ¸ ì´ˆê¸°í™” */
function syncCartWithStock(){
  for (const id in cart){
    if (!stockMap[id] || cart[id] > stockMap[id]){
      alert('ì¬ê³ ê°€ ë³€ê²½ë˜ì–´ ì¥ë°”êµ¬ë‹ˆë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ì„ íƒí•´ ì£¼ì„¸ìš”.');
      resetCart();
      return false;
    }
  }
  return true;
}

function resetCart(){
  for (const id in cart) delete cart[id];
  document.querySelectorAll('#menu span[id^="qty"]').forEach(s=>s.textContent=0);
  calcTotal();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìˆ˜ëŸ‰ + / - â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
window.add = id=>{
  if (locked || stockMap[id]===0) return;
  const next = (cart[id]||0)+1;
  if (next > stockMap[id]){ alert('ì¬ê³  ë¶€ì¡±!'); return; }
  cart[id]=next;
  document.getElementById(`qty${id}`).textContent = next;
  calcTotal();
};

window.sub = id=>{
  if (locked || !cart[id]) return;
  cart[id]--;
  if (cart[id]===0) delete cart[id];
  document.getElementById(`qty${id}`).textContent = cart[id]||0;
  calcTotal();
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ UI ì ê¸ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function lockUI(){
  locked = true;
  document.querySelectorAll('#menu button').forEach(b=>b.disabled=true);
  document.getElementById('name').disabled = true;
  const btn = document.getElementById('orderBtn');
  btn.disabled = true;
  btn.textContent = 'ì£¼ë¬¸ ì™„ë£Œ (ìˆ˜ì • ë¶ˆê°€)';
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì£¼ë¬¸í•˜ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.getElementById('orderBtn').onclick = async ()=>{
  if (locked) return;

  const ok = await loadMenu();                   // ìµœì‹  ì¬ê³ Â·ê°€ê²© ë°˜ì˜
  if (!ok || !Object.keys(cart).length) return;  // ì¬ê³  ì¶©ëŒ ì‹œ ì¤‘ë‹¨

  const name = document.getElementById('name').value.trim();
  if (!name){ alert('ì…ê¸ˆìëª… ì…ë ¥!'); return; }

  const res = await fetch('/api/order',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        table,
        name,
        cart:Object.entries(cart).map(([id,qty])=>({id:+id,qty}))
      })
  }).then(r=>{
      if(!r.ok) return r.json().then(j=>{throw j});
      return r.json();
  }).catch(err=>{
      if(err.msg==='soldout'){
        alert(`${err.itemName} ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.\në‚¨ì€ ìˆ˜ëŸ‰: ${err.remain}`);
        resetCart(); loadMenu(); locked=false;
      }else alert('ì£¼ë¬¸ ì‹¤íŒ¨');
      return null;
  });
  if(!res) return;

  lockUI();
  resultDiv.innerHTML = `
    <h3>${table}ë²ˆ í…Œì´ë¸” ê²°ì œ ì•ˆë‚´</h3>
    <p><b>ê³„ì¢Œ</b>: ${res.bank.account} / ${res.bank.holder}</p>
    <p><b>ì…ê¸ˆì•¡</b>: ${res.amount.toLocaleString()}ì›</p>
    <p><b>ì…ê¸ˆìëª…</b>: ${res.bank.depositor}</p>
    <p>ğŸ“¡ ê²°ì œ í™•ì¸ ì¤‘...</p>`;
  pollStatus(res.orderId);
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ê²°ì œ ìƒíƒœ í´ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function pollStatus(id){
  const timer = setInterval(async ()=>{
    const o = await fetch('/api/order/'+id).then(r=>r.json());
    if(o.status==='paid'){
      resultDiv.innerHTML='<h2 style="color:green">ê²°ì œ ì™„ë£Œ! ê°ì‚¬í•©ë‹ˆë‹¤ ğŸ‰</h2>';
      clearInterval(timer);
    }else if(o.status==='manual_check'){
      resultDiv.innerHTML='<h2 style="color:red">í™•ì¸ í•„ìš”! ì§ì› í˜¸ì¶œ ì¤‘</h2>';
      clearInterval(timer);
    }
  },3000);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì´ˆê¸° í™”ë©´ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
loadMenu();
</script>
</body>
</html>