<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì£¼ë¬¸ ê´€ë¦¬ì</title>
<style>
body{font-family:sans-serif;margin:20px;max-width:640px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
tr.pending{background:#fff9c4}
tr.paid{background:#c8e6c9}
tr.served td{opacity:.5;text-decoration:line-through}
button{padding:4px 8px}
</style>
</head>
<body>
<h2>ğŸ“‹ ì‹¤ì‹œê°„ ì£¼ë¬¸ í˜„í™©</h2>
<table id="tbl">
  <thead>
    <tr><th>ID</th><th>í…Œì´ë¸”</th><th>ì´ë¦„</th><th>ê¸ˆì•¡</th>
        <th>ê²°ì œ</th><th>ì£¼ë¬¸</th><th>ì¡°ì‘</th></tr>
  </thead>
  <tbody></tbody>
</table>
<script>
const key = new URLSearchParams(location.search).get('key');
if (!key) { alert('í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤'); throw ''; }

async function fetchOrders(){
  const rows = await fetch(`/api/admin/orders?key=${key}`).then(r=>r.json());
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = '';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.className = `${r.status} ${r.served? 'served':''}`;
    tr.innerHTML=`
      <td>${r.id}</td><td>${r.table_no}</td><td>${r.name}</td>
      <td>${r.amount.toLocaleString()}ì›</td>
      <td>${r.status}</td>
      <td>${r.items_text}</td>
      <td>
        <button ${(r.served || r.status !== 'paid') ? 'disabled' : ''}
          onclick="serve(${r.id},${r.served?0:1})">
          ${r.served?'ë˜ëŒë¦¬ê¸°':'ìŒì‹ ì „ë‹¬'}
        </button>

        <!-- â˜… ì‹ ê·œ: ê²°ì œ ìˆ˜ë™ í™•ì¸ ë²„íŠ¼ -->
        <button
          ${r.status === 'paid' ? 'disabled' : ''}
          onclick="setPaid(${r.id})">
          ê²°ì œ í™•ì¸
        </button>
      </td>`;
    tbody.appendChild(tr);
  });
}
async function serve(id, val){
  await fetch(`/api/admin/order/${id}/serve?key=${key}`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({served:val})
  });
  fetchOrders();
}
async function setPaid(id){
  await fetch(`/api/admin/order/${id}/pay?key=${key}`, {
    method:'POST'
  });
  fetchOrders();          // ìƒíƒœ ìƒˆë¡œê³ ì¹¨
}
setInterval(fetchOrders, 4000); // 4ì´ˆë§ˆë‹¤ ìƒˆë¡œê³ ì¹¨
fetchOrders();
</script>
</body>
</html>